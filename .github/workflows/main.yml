name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  workflow_dispatch:

env:
  DEVELOPER_DIR: /Applications/Xcode_13.0.app/Contents/Developer

jobs:
  build:
    runs-on: macOS-11

    steps:
      # チェックアウト
      - uses: actions/checkout@v2

      # Actionsで使用できるXcodeの一覧出力
      - name: Show Xcode list
        run: ls /Applications | grep 'Xcode'
      
      # 現在使われているXcodeのバージョン出力
      - name: Show Xcode version
        run: xcodebuild -version
      
      # Mintのインストール
      - name: Install Mint
        run: brew install mint
      
      # Mintで管理しているライブラリをインストール
      - name: Install Mint library
        run: mint bootstrap
      
      # プロジェクトファイルの生成
      - name: Generate Xcode project with XcodeGen
        run: mint run xcodegen xcodegen generate
      
      # SPMのライブラリーをキャッシュ
      - name: Cache Swift Packages
        uses: actions/cache@v1
        with:
          path: SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('*.xcodeproj/project.xcworkspace/ xcshareddata/swiftpm/Package.resolved') }}
          restore-keys: ${{ runner.os }}-spm-
      
      # 単体テスト(確認)
      - name: Xcode Test(Test)
        run: swift test -v
      
      # 単体テスト
      - name: Xcode test
        run: xcodebuild
          -sdk iphonesimulator
          -configuration Debug
          -clonedSourcePackagesDirPath SourcePackages
          -scheme Samidare-Develop
          -destination 'platform=iOS Simulator,name=iPhone 13 Pro Max'
          -skip-testing:Samidare-iOSUITests
          clean test

